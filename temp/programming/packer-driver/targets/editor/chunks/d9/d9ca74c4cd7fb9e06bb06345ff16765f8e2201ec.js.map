{"version":3,"sources":["file:///C:/Users/PC/Desktop/Slot_Assignment/assets/scripts/Main.ts"],"names":["_decorator","Component","Node","Sprite","SpriteFrame","Label","Color","MockApi","ccclass","property","Main","isInitialized","isSpinning","balance","betAmount","onLoad","onInitData","data","handleInitResponse","onPlayResponse","anyData","handlePlayResponse","winLabel","string","totalWin","playButtonNode","on","EventType","TOUCH_END","onPlayPressed","setButtonEnabled","start","init","updateBalanceLabel","clearHighlights","fakeSpin","play","reels","defaultReels","applyReels","defaultBet","console","log","winLines","resultReels","win","length","first","winIndexes","highlightIndexes","scheduleOnce","enabled","s","getComponent","grayscale","symbolFrames","i","cell","cells","r","Math","floor","random","f","spriteFrame","col","row","index","symbolId","cellSprite","frame","node","setScale","color","WHITE","indexes","winSet","Set","forEach","idx","has","balanceLabel"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Sprite, SpriteFrame, Label, Color } from 'cc';\nimport { MockApi, InitData, PlayData } from './MockApi';\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('Main')\nexport class Main extends Component {\n  @property([Sprite])\n  public cells: Sprite[] = [];\n\n  @property([SpriteFrame])\n  public symbolFrames: SpriteFrame[] = [];\n\n  @property(Node)\n  public playButtonNode: Node | null = null;\n\n  @property(Label)\n  public winLabel: Label | null = null;\n\n  @property(Label)\n  public balanceLabel: Label | null = null;\n\n  private isInitialized = false;\n  private isSpinning = false;\n  private balance = 0;\n  private betAmount = 0;\n\n  onLoad() {\n    MockApi.onInitData((data: InitData) => this.handleInitResponse(data));\n\n    MockApi.onPlayResponse((data: PlayData) => {\n      const anyData = data as any;\n      this.handlePlayResponse(data);\n      if (this.winLabel) this.winLabel.string = `Win: ${anyData.totalWin ?? 0}`;\n    });\n\n    if (this.playButtonNode) {\n      this.playButtonNode.on(Node.EventType.TOUCH_END, this.onPlayPressed, this);\n      this.setButtonEnabled(false);\n    }\n  }\n\n  start() {\n    MockApi.init();\n  }\n\n  private onPlayPressed() {\n    if (!this.isInitialized) return;\n    if (this.isSpinning) return;\n\n    // apply bet immediately on play\n    if (this.betAmount > 0) {\n      this.balance -= this.betAmount;\n      this.updateBalanceLabel();\n    }\n\n    this.isSpinning = true;\n    this.setButtonEnabled(false);\n    this.clearHighlights();\n    if (this.winLabel) this.winLabel.string = 'Win: 0';\n\n    this.fakeSpin();\n    MockApi.play();\n  }\n\n  private handleInitResponse(data: InitData) {\n    const anyData = data as any;\n\n    const reels = anyData.defaultReels ?? anyData.reels;\n    if (!reels) return;\n\n    this.applyReels(reels);\n\n    // read initial balance and bet from init payload\n    this.balance = anyData.balance ?? 0;\n    this.betAmount = anyData.defaultBet ?? 0;\n    this.updateBalanceLabel();\n    this.isInitialized = true;\n    this.setButtonEnabled(true);\n\n    if (this.winLabel) this.winLabel.string = 'Win: 0';\n  }\n\n  private handlePlayResponse(data: PlayData) {\n    const anyData = data as any;\n\n    console.log('reels=', data.reels);\n    console.log('winLines=', data.winLines);\n\n    const reels = anyData.reels ?? anyData.resultReels ?? anyData.defaultReels;\n    if (!reels) {\n      this.isSpinning = false;\n      this.setButtonEnabled(true);\n      return;\n    }\n\n    this.applyReels(reels);\n\n    // add win amount back to balance\n    const win = anyData.totalWin ?? 0;\n    if (win > 0) {\n      this.balance += win;\n      this.updateBalanceLabel();\n    }\n\n    // Use the WinLine objects from MockApi: take the first win and highlight its indexes\n    const winLines = (data as PlayData).winLines;\n    if (winLines && winLines.length > 0) {\n      const first = winLines[0];\n      if (first && first.winIndexes && first.winIndexes.length === 3) {\n        this.highlightIndexes(first.winIndexes);\n      }\n    }\n\n    // I found this method from the Cocos documentation to be a good place to disable the button after spin for 0.15 seconds\n    this.scheduleOnce(() => {\n      this.isSpinning = false;\n      this.setButtonEnabled(true);\n    }, 0.15);\n  }\n\n  private setButtonEnabled(enabled: boolean) {\n    if (!this.playButtonNode) return;\n    const s = this.playButtonNode.getComponent(Sprite);\n    if (s) s.grayscale = !enabled;\n  }\n\n  private fakeSpin() {\n    if (!this.symbolFrames.length) return;\n\n    // this imitates the actual spin by scheduling a random frame for each cell over 6 iterations\n    for (let i = 0; i < 6; i++) {\n      this.scheduleOnce(() => {\n        for (const cell of this.cells) {\n          const r = Math.floor(Math.random() * this.symbolFrames.length);\n          const f = this.symbolFrames[r];\n          if (cell && f) cell.spriteFrame = f;\n        }\n      }, i * 0.05);\n    }\n  }\n\n  private applyReels(reels: number[][]) {\n    if (this.cells.length !== 9) return;\n    if (this.symbolFrames.length < 4) return;\n\n    for (let col = 0; col < 3; col++) {\n      for (let row = 0; row < 3; row++) {\n        const index = col * 3 + row;\n        const symbolId = reels?.[col]?.[row];\n        const cellSprite = this.cells[index];\n        if (!cellSprite) continue;\n\n        const frame = this.symbolFrames[(symbolId ?? 1) - 1];\n        if (frame) cellSprite.spriteFrame = frame;\n      }\n    }\n  }\n\n  private clearHighlights() {\n    for (const s of this.cells) {\n      if (!s) continue;\n      s.node.setScale(1, 1);\n      s.color = Color.WHITE;\n    }\n  }\n\n  private highlightIndexes(indexes: number[]) {\n    this.clearHighlights();\n\n    const winSet = new Set(indexes);\n\n    this.cells.forEach((s, idx) => {\n      if (!s) return;\n      if (winSet.has(idx)) {\n        s.node.setScale(1.05, 1.05);\n        s.color = new Color(255, 230, 120);\n      }\n    });\n  }\n\n  private updateBalanceLabel() {\n    if (!this.balanceLabel) return;\n    this.balanceLabel.string = `Balance: ${this.balance}`;\n  }\n}\n"]}